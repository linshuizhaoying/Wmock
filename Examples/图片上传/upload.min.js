(function(n,g){var m=function(a,b){this.element=a;this.message=g.extend({notice:this.notice},b);this.errorNotice=this.message.notice};m.prototype={files:null,scale:1,maxScale:3,range:.05,fileSize:0,multipleNum:0,mouseOffsetX:0,mouseOffsetY:0,isDown:!1,fileTypeConfig:{img:"\u56fe\u7247",file:"\u6587\u4ef6"},isPc:function(a){a=a.userAgent;for(var b="Android;iPhone;SymbianOS;Windows Phone;iPad;iPod".split(";"),c=!0,d=0;d<b.length;d++)if(-1<a.indexOf(b[d])){c=!1;break}return c}(navigator),loading:function(a){for(var b=
  "",c=1;12>=c;c++)b+="<div class='sk-circle"+c+" sk-child'></div>";a=g("<div class='removeLoading ljkPopup modal' style='display: block'><div class='mask'><div class='loading'><div class='sk-circle'>"+b+"</div><p class='text-center fz18 color-white mt30'>"+(a?a:"\u8bf7\u7a0d\u540e")+"</p></div></div>");g("body").append(a)},notice:function(a,b,c,d){var f=g('<div class="ljkPopup modal" style="display:block"><div class="mask"></div><div class="ljkPopup-wrap modal-wrap ctrl-modal"><div class="modal-title"><h2 class="none">'+
  (d?d:"\u63d0\u793a")+'</h2></div><table><tr><td><h1 class="none mt20">'+a+"</h1></td></tr></table></div></div>");g("body").append(f);b="undefined"==typeof b?1500:Math.max(parseInt(b),1500);var h=setTimeout(function(){clearTimeout(h);setTimeout(function(){f.remove();"function"==typeof c&&c()},500);f.css("opacity",0)},b)},removeLoading:function(){g(".removeLoading").remove()},selectImg:function(a){"object"==typeof a&&(a.fileSelectBtn?a.fileSelectBtn.on("click",function(){a.fileBtn.click()}):a.fileBtn.click())},
  getBoundingClientRect:function(a){a=a.getBoundingClientRect();return{left:a.left,top:a.top}},moveImage:function(a){if("object"==typeof a){var b=this.isPc,c=this;a.ele.on(b?"mousedown":"touchstart",function(d){d=b?d:d.originalEvent.targetTouches[0]||d.targetTouches[0];c.isDown=!0;c.mouseOffsetX=d.pageX-~~this.getBoundingClientRect(a.ele.get(0)).left;c.mouseOffsetY=d.pageY-~~this.getBoundingClientRect(a.ele.get(0)).top});a.ele.on(b?"mousemove":"touchmove",function(d){d.preventDefault();var f;f=b?d:
  d.originalEvent.touches[0]||d.originalEvent.changedTouches[0]||d.targetTouches[0];!0===c.isDown&&(d=f.pageX-c.mouseOffsetX,f=f.pageY-c.mouseOffsetY,a.ele.css({top:f+"px",left:d+"px"}))});a.ele.on(b?"mouseup":"touchend",function(a){a.preventDefault();c.isDown=!1});a.ele.on(b?"mouseout":"touchcancel",function(a){a.preventDefault();c.isDown=!1})}},showImage:function(a){a=g.extend({maxSize:1024,zoom:!1},a);if("object"==typeof a){var b=this;b.selectImg(a);b.getFileInfo(a.fileBtn,a.maxSize,b.fileTypeConfig.img,
  !1,function(c){b.resetScale(a.range,a.showEle);b.appendImage(c.result,a.fileSelectBtn,a.showEle,function(b){a.callback&&a.callback(b)});!0===a.zoom&&b.bindMouseWheel(a.range,a.showEle);a.fileBtn.blur()})}},resetScale:function(a,b){a&&a.val(1);this.ToScale(b,1)},appendImage:function(a,b,c,d){this.loadImage(a).then(function(f){b&&b.addClass("success-linear");c.html("").append(f).removeClass("hasImg");d&&d(a)}).catch(function(a){this.errorNotice("\u6dfb\u52a0\u56fe\u7247\u8282\u70b9\u51fa\u9519!");throw Error(a);
  })},bindMouseWheel:function(a,b){var c=this,d=c.maxScale,f=c.range;b.get(0).onmousewheel=function(h){var l=c.scale;h=h||window.event;h=h.delta?h.delta:h.wheelDelta;if(0<h)l+=f,l=Math.min(l,d),a&&a.val(l),c.ToScale(b,l);else if(0>h)l-=f,l=Math.max(0,l),a&&a.val(l),c.ToScale(b,l);else return!1}},getFileInfo:function(a,b,c,d,f){var h=this;c=c||h.fileTypeConfig.file;a.on("change",function(){window.FileReader?(h.files=Array.prototype.slice.call(this.files),h.filterFileInfo(h.files,c,b,d,function(a){f(a)})):
  h.errorNotice("\u6d4f\u89c8\u5668\u7248\u672c\u8fc7\u4f4e")})},filterFileInfo:function(a,b,c,d,f){var h=this;!d&&a.length&&1<a.length?b==h.fileTypeConfig.img?h.errorNotice("\u53ea\u80fd\u4e0a\u4f201\u5f20\u56fe\u7247:)"):h.errorNotice("\u53ea\u80fd\u4e0a\u4f201\u4e2a\u6587\u4ef6:)"):a.forEach(function(a,d){h.readerImage(b,a,c,function(a){f(a)})})},readerImage:function(a,b,c,d){var f=this;if(a==f.fileTypeConfig.img){var h=b.type.split("/").pop();if(!/\/(?:jpeg|jpg|png|gif)/i.test(b.type)){f.errorNotice("\u4e0d\u652f\u6301"+
  (h?h:"\u8fd9\u79cd")+"\u683c\u5f0f\u7684"+(h?a:"\u6587\u4ef6")+"\u54df");return}}"undefined"!=c&&"number"==typeof c&&b.size/1024>c?f.errorNotice("\u62b1\u6b49,"+a+" \u6700\u5927\u4e3a "+c+" KB"):(a=new FileReader,a.onprogress=function(){f.loading("\u8bfb\u53d6\u4e2d,\u8bf7\u7a0d\u540e")},a.onerror=function(){f.removeLoading();f.errorNotice("\u8bfb\u53d6\u5931\u8d25")},a.onabort=function(){f.removeLoading();f.errorNotice("\u7f51\u7edc\u5f02\u5e38!")},a.onload=function(){f.removeLoading();var a=this.result;
  d&&d({name:b.name,type:b.type,size:b.size,result:a})},a.readAsDataURL(b))},loadImage:function(a){return new Promise(function(b,c){var d=new Image;d.src=a;d.onload=function(){b(d)};d.onerror=function(){c(e)}})},rangeToScale:function(a){if("object"==typeof a){var b=this,c=this.isPc,d=b.scale;a.range.on(c?"mousemove ":"touchmove",function(a){a=g(this);d=Number(a.val());f(d)}).prev().on(c?"mouseover ":"touchstart",function(){d-=.01;f(d)}).next().next().on(c?"mouseover":"touchstart",function(){d+=.01;
  f(d)});var f=function(c){a.range&&a.range.val(c);b.ToScale(a.ele,c)}}},ToScale:function(a,b){a.css({"-webkit-transform":"scale("+b+")","-moz-transform":"scale("+b+")","-ms-transform":"scale("+b+")","-o-transform":"scale("+b+")",transform:"scale("+b+")"});this.scale=b},clipImage:function(a){var b=this;if("object"==typeof a){var c={uploadBtn:g(".upload-upload-btn"),uploadImageBox:g(".move-image"),clipImage:g(".clip-image"),range:g("#range")};a=g.extend(c,a);b.canvas=document.createElement("canvas");
  a.uploadBtn.on("click",function(){try{if(a.uploadImageBox.hasClass("hasImg"))b.errorNotice("\u8bf7\u9009\u62e9\u56fe\u7247");else{var c=a.uploadImageBox.find("img"),f=b.canvas.getContext("2d"),h=a.clipImage.width(),g=a.clipImage.height();b.canvas.width=h;b.canvas.height=g;var k=a.range.val()||a.range.value,p=~~(a.clipImage.offset().left-a.uploadImageBox.offset().left),q=~~(a.clipImage.offset().top-a.uploadImageBox.offset().top);f.drawImage(c.get(0),p/k,q/k,h/k,g/k,0,0,h,g);var r=b.canvas.toDataURL(a.quality&&
  "number"===typeof a.quality?"image/jpeg":"image/png",Number(a.quality));delete this.canvas;if("function"!=typeof a.clipSuccess)throw Error("\u8bf7\u4f7f\u7528clipSuccess\u56de\u8c03\u51fd\u6570:(");a.clipSuccess(r)}}catch(t){a.clipError("error:"+t)}})}},clipUpload:function(a){var b=this;a=g.extend({maxSize:1024,drag:!0,zoom:!0,paste:!0,dragAreaActiveClassName:"dragActive",success:function(){},error:function(){}},a);this.moveImage({ele:a.showEle});this.showImage({range:a.range,fileSelectBtn:a.fileSelectBtn,
  fileBtn:a.fileBtn,showEle:a.showEle,maxSize:a.maxSize,zoom:a.zoom});this.rangeToScale({range:a.range,ele:a.showEle});this.clipImage({range:a.range,quality:a.quality,clipSuccess:function(b){a.success(b)},clipError:function(b){a.error(b)}});!0===a.drag&&a.dragArea&&this.addListener({type:this.fileTypeConfig.img,fileBtn:a.fileBtn,dragArea:a.dragArea,fileArea:a.showEle,maxSize:a.maxSize,range:a.range,dragAreaActiveClassName:a.dragAreaActiveClassName,callback:function(c){b.appendImage(c.result,a.fileSelectBtn,
  a.showEle)}});!0===a.paste&&this.addPasteListener(function(c){b.readerImage(b.fileTypeConfig.img,c,a.maxSize,function(c){b.appendImage(c.result,a.fileSelectBtn,a.showEle);!0===a.zoom&&b.bindMouseWheel(a.range,a.showEle)})})},addPasteListener:function(a){var b=this;g(document.body).on("paste",function(c){if(c=(window.clipboardData||c.originalEvent.clipboardData).items){c=c[0];if("file"!=c.kind.toLocaleLowerCase())return b.errorNotice("\u6587\u4ef6\u7c7b\u578b\u4e0d\u6b63\u786e\uff01");a&&a(c.getAsFile())}})},
  uploadFile:function(a,b,c,d,f,h,g){var k=new XMLHttpRequest;a.on("click",function(){var a=b?new FormData(b[0]):new FormData;if(d){var l=Object.keys(d)[0];!b&&d&&a.append(Object.keys(d)[0],d[l])}k.onloadstart=function(){console.log("\u5f00\u59cb\u4e0a\u4f20...")};k.onerror=function(a){_this.errorNotice("\u4e0a\u4f20\u5931\u8d25!");h&&h(a)};k.onload=function(){var a=JSON.parse(k.responseText);g&&g(a)};k.onabort=function(a){_this.errorNotice("\u4e0a\u4f20\u4e2d\u65ad!")};k.ontimeout=function(){_this.errorNotice("\u8fde\u63a5\u8d85\u65f6!")};
  k.onloadend=function(){console.log("\u4f20\u8f93\u7ed3\u675f")};k.upload.onprogress=function(a){console.info("\u4e0a\u4f20\u4e2d...");a=Math.round(100*a.loaded/a.total);f&&f(a)};k.open("POST",c,!0);k.send(a)})},fileUpload:function(a){a=g.extend({maxSize:1024,onChange:function(){},progress:function(){},error:function(){},success:function(){}},a);var b=this;if(!a.url)throw Error("No upload address specified");b.selectImg(a);b.getFileInfo(a.fileBtn,a.maxSize,b.fileTypeConfig.file,!1,function(c){a.onChange&&
  a.onChange(c);b.uploadFile(a.fileUploadBtn,a.form,a.url,void 0,a.progress,a.error,a.success)});!0===a.drag&&a.dragArea&&b.addListener(g.extend(a,{type:b.fileTypeConfig.file}))},bindmultipleEvent:function(a,b,c,d,f,h){var g=this,k=~~(b.size/1024);a=g.createMultipleItem(++a,k);f.append(a.item);g.appendImage(b.result,d,a.warp);g.multipleSizeChange(h,b,k,1,!0);g.removeMultipleItem(a.remove,function(){g.multipleSizeChange(h,b,k,g.multipleNum,!1)});c.blur()},multipleUpload:function(a){var b={maxSize:1024,
  drag:!0,paste:!0,multipleSection:g(".multiple-list"),dragAreaActiveClassName:"multiple-area-active",onChange:function(){}},c=a.multipleSection;a=g.extend(b,a);var d=this;d.selectImg(a);d.getFileInfo(a.fileBtn,a.maxSize,d.fileTypeConfig.img,!0,function(b){d.bindmultipleEvent(0,b,a.fileBtn,a.fileSelectBtn,c,a.onChange)});!0===a.paste&&this.addPasteListener(function(b){d.readerImage(d.fileTypeConfig.img,b,a.maxSize,function(b){d.bindmultipleEvent(0,b,a.fileBtn,a.fileSelectBtn,c,a.onChange)})});!0===
  a.drag&&a.dragArea&&d.addListener(g.extend(a,{zoom:!1,type:d.fileTypeConfig.file,callback:function(b){d.bindmultipleEvent(0,b,a.fileBtn,a.fileSelectBtn,c,a.onChange)}}));a.uploadBtn&&a.uploadBtn.on("click",function(){if(0>=d.multipleNum||0>=d.allFileSize)return d.errorNotice("\u8bf7\u9009\u62e9\u6587\u4ef6!")})},multipleSizeChange:function(a,b,c,d,f){a&&a(g.extend(b,{allFileSize:f?this.fileSize+=c:this.fileSize-=c,size:c,multipleNum:f?this.multipleNum+=d:--this.multipleNum}))},removeMultipleItem:function(a,
  b){a.on("click",function(){g(this);var a=g(this).data("id");g(this).data("size");g("#upload-"+a).remove();b&&b()})},createMultipleItem:function(a,b){a=g('<li class="multiple-item" id="upload-'+a+'"><div class="mask"><a href="javascript:;" data-id="'+a+'" data-size="'+(!!b||0)+'">\u5220\u9664</a></div><div class="item-warp hasImg"></div></li>');return{item:a,warp:a.find(".item-warp"),mask:a.find(".mask"),remove:a.find("a")}},addDragAreaStyle:function(a,b){a.addClass(b||"dragActive")},removeDragAreaStyle:function(a,
  b){a.removeClass(b||"dragActive")},stopAll:function(a){a.preventDefault();a.stopPropagation()},addListener:function(a){a=g.extend({zoom:!0,type:this.fileTypeConfig.img,dragAreaActiveClassName:"dragActive"},a);var b=a.dragArea,c=a.dragAreaActiveClassName,d=b.get(0),f=this;document.addEventListener("dragenter",function(a){f.addDragAreaStyle(b,c)},!1);document.addEventListener("dragleave",function(){f.removeDragAreaStyle(b,c)},!1);d.addEventListener("dragenter",function(a){f.stopAll(a);f.addDragAreaStyle(b,
  c)},!1);d.addEventListener("dragleave",function(a){f.stopAll(a);f.removeDragAreaStyle(b,c)},!1);d.addEventListener("dragover",function(a){(a.dataTransfer||a.originalEvent.dataTransfer).dropEffect="copy";f.stopAll(a);f.addDragAreaStyle(b,c)},!1);d.addEventListener("drop",function(d){f.stopAll(d);f.removeDragAreaStyle(b,c);var g=(d.dataTransfer||d.originalEvent.dataTransfer).files;f.filterFileInfo(Array.from(g),a.type,a.maxSize,!1,function(b){if(a.type==f.fileTypeConfig.img)a.range&&f.resetScale(a.range,
  a.fileArea),a.callback&&a.callback(b),!0===a.zoom&&f.bindMouseWheel(a.range,a.fileArea);else{var c={};c[a.fileBtn.attr("name")]=g[0];a.onChange&&a.onChange(b);f.uploadFile(a.fileUploadBtn,void 0,a.url,c,a.progress,a.error,a.success)}})},!1)},fileTypeRegExp:function(a,b){return(new RegExp(".*/(?:"+a+")$","i")).test(b)}};n.Upload=m})(window,jQuery);
